<!doctype html>
<html lang="en">
  <head>
    <title>&lt;model-viewer&gt; template</title>
    <meta charset="utf-8">
    <meta name="description" content="&lt;model-viewer&gt; template">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" href="./styles.css" rel="stylesheet"/>
    <link type="text/css" href="./styles_2.css" rel="stylesheet"/>

    <!-- Favicon -->
    <link rel="icon" href="./favicon.svg" type="image/svg+xml">
    <link rel="icon" href="./favicon-32.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="./favicon-180.png">
    <meta name="theme-color" content="#0b0c0f">

    <!-- Stile minimo per le linee tratteggiate (come nella demo) -->
    <style>
      .dimensionLineContainer{ pointer-events:none; display:block; }
      .dimensionLine{ stroke:#16a5e6; stroke-width:2; stroke-dasharray:2; }
      .dim.hide, .dimensionLine.hide{ display:none; }
    </style>
  </head>
  <body>
    <model-viewer
      id="mv"
      src="mec.glb"
      ar
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      tone-mapping="neutral"
      poster="poster.webp"
      shadow-intensity="1.75"
      exposure="1"
      environment-image="aircraft_workshop_01_1k.hdr"
      min-camera-orbit="auto auto 5.201m"
      min-field-of-view="15.67deg">

      <!-- I TUOI HOTSPOT (annotazioni) - restano invariati e ora sono togliibili -->
      <button class="Hotspot" slot="hotspot-1" data-position="1.4000000029802322m 1.3092575080869793m -0.4607462984277556m" data-normal="1m 0m 0m" data-visibility-attribute="visible">
        <div class="HotspotAnnotation">Quadro comandi</div>
      </button>
      <button class="Hotspot" slot="hotspot-2" data-position="-1.524990965533547m 0.5350553818937596m -0.053372119837808485m" data-normal="-0.999999914771973m -2.7847247302913394e-16m -0.0004128632301981563m" data-visibility-attribute="visible">
        <div class="HotspotAnnotation">Accessorio lavaggio automatico</div>
      </button>
      <button class="Hotspot" slot="hotspot-3" data-position="0.05600506067275912m 2.7996217155077723m -0.9863649904899031m" data-normal="1m 5.551120000000018e-17m -2.220446049250313e-16m" data-visibility-attribute="visible">
        <div class="HotspotAnnotation">Attuatore con vite a ricircolo di sfere</div>
      </button>
      <button class="Hotspot" slot="hotspot-4" data-position="-0.42334172946592913m 2.222854283116906m 0.1120040605729068m" data-normal="0m 1m 1.0880185641326534e-14m" data-visibility-attribute="visible">
        <div class="HotspotAnnotation">Tappo anti schizzo con sistema di adduzione liquido-solido</div>
      </button>
      <button class="Hotspot" slot="hotspot-5" data-position="0.02172138808452495m 1.3478399997764823m 0.05693380016905908m" data-normal="7.107045327439278e-15m 1m 1.530780264173269e-14m" data-visibility-attribute="visible">
        <div class="HotspotAnnotation">Frusta con doppia lama</div>
      </button>

      <!-- === BOUNDING BOX DIMENSIONS (come nella demo) === -->
      <!-- Vertici (8 dot) -->
      <button slot="hotspot-dot+X-Y+Z" class="dot dim"    data-position="1 -1  1" data-normal="1 0 0"></button>
      <button slot="hotspot-dot+X-Y-Z" class="dot dim"    data-position="1 -1 -1" data-normal="1 0 0"></button>
      <button slot="hotspot-dot+X+Y-Z" class="dot dim"    data-position="1  1 -1" data-normal="0 1 0"></button>
      <button slot="hotspot-dot-X+Y-Z" class="dot dim"    data-position="-1 1 -1" data-normal="0 1 0"></button>
      <button slot="hotspot-dot-X-Y-Z" class="dot dim"    data-position="-1 -1 -1" data-normal="-1 0 0"></button>
      <button slot="hotspot-dot-X-Y+Z" class="dot dim"    data-position="-1 -1 1" data-normal="-1 0 0"></button>

      <!-- Etichette dimensioni (3) sulle tre facce ortogonali -->
      <button slot="hotspot-dim+X-Y" class="dim" data-position="1 -1 0"  data-normal="1 0 0"></button> <!-- mostra Z -->
      <button slot="hotspot-dim+X-Z" class="dim" data-position="1  0 -1" data-normal="1 0 0"></button> <!-- mostra Y -->
      <button slot="hotspot-dim-X-Z" class="dim" data-position="-1 0 -1" data-normal="-1 0 0"></button> <!-- mostra Y (lato opposto) -->
      <button slot="hotspot-dim-Y-Z" class="dim" data-position="0  1 -1" data-normal="0 1 0"></button>  <!-- mostra X -->
      <button slot="hotspot-dim-X-Y" class="dim" data-position="-1 -1 0" data-normal="-1 0 0"></button> <!-- mostra Z (lato opposto) -->

      <!-- Linee tratteggiate (5) -->
      <svg id="dimLines" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" class="dimensionLineContainer">
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
      </svg>

      <!-- barra di progresso / AR prompt -->
      <div class="progress-bar hide" slot="progress-bar"><div class="update-bar"></div></div>
      <button slot="ar-button" id="ar-button">View in your space</button>
      <div id="ar-prompt"><img src="ar_hand_prompt.png" alt=""></div>
    </model-viewer>

    <!-- UI overlay: toggle annotazioni + dimensioni -->
    <div class="mv-ui">
      <label><input type="checkbox" id="toggle-annotazioni" checked> Mostra annotazioni</label>
      <label><input type="checkbox" id="toggle-dimensioni" checked> Mostra dimensioni</label>
    </div>

    <!-- Logo -->
    <div class="logo-overlay">
      <img src="./Asset%2026BW.svg" alt="Logo">
    </div>

    <script src="script.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

    <!-- Logica dimensioni + toggle (adattata dalla demo ufficiale) -->
    <script>
      (function(){
        const mv = document.getElementById('mv');

        // --- Toggle ---
        const chkAnno = document.getElementById('toggle-annotazioni');
        const chkDims = document.getElementById('toggle-dimensioni');

        function setAnnoVisibility() {
          mv.querySelectorAll('.Hotspot:not(.dim)').forEach(el => {
            el.style.display = chkAnno.checked ? '' : 'none';
          });
        }

        function setDimsVisibility(visible) {
          // Etichette + linee + dot
          const dimEls = [
            ...mv.querySelectorAll('.dim'),
            mv.querySelector('#dimLines')
          ];
          dimEls.forEach(el => {
            if (!el) return;
            if (visible) el.classList.remove('hide');
            else el.classList.add('hide');
          });
        }

        chkAnno.addEventListener('change', setAnnoVisibility);
        chkDims.addEventListener('change', ()=> setDimsVisibility(chkDims.checked));

        // In AR: nascondi overlay quando parte una sessione "esterna" (Scene Viewer / Quick Look)
        mv.addEventListener('ar-status', (ev)=>{
          const {status, mode} = ev.detail; // mode = 'webxr' | 'scene-viewer' | 'quick-look'
          const allowOverlay = (mode === 'webxr'); // overlay visibili solo in WebXR
          setDimsVisibility(chkDims.checked && allowOverlay && status !== 'session-started');
          setAnnoVisibility(); // le annotazioni restano sotto controllo del checkbox; ma in non-WebXR non si vedono comunque
        });

        // --- Linee tratteggiate (SVG) ---
        const dimLines = mv.querySelectorAll('#dimLines line');

        function drawLine(svgLine, aName, bName, tieToName) {
          const a = mv.queryHotspot(aName);
          const b = mv.queryHotspot(bName);
          const tie = tieToName ? mv.queryHotspot(tieToName) : null;
          if (!a || !b) return;

          svgLine.setAttribute('x1', a.canvasPosition.x);
          svgLine.setAttribute('y1', a.canvasPosition.y);
          svgLine.setAttribute('x2', b.canvasPosition.x);
          svgLine.setAttribute('y2', b.canvasPosition.y);

          if (tie && !tie.facingCamera) svgLine.classList.add('hide');
          else svgLine.classList.remove('hide');
        }

        const renderSVG = () => {
          drawLine(dimLines[0], 'hotspot-dot+X-Y+Z', 'hotspot-dot+X-Y-Z', 'hotspot-dim+X-Y');
          drawLine(dimLines[1], 'hotspot-dot+X-Y-Z', 'hotspot-dot+X+Y-Z', 'hotspot-dim+X-Z');
          drawLine(dimLines[2], 'hotspot-dot+X+Y-Z', 'hotspot-dot-X+Y-Z'); // sempre visibile
          drawLine(dimLines[3], 'hotspot-dot-X+Y-Z', 'hotspot-dot-X-Y-Z', 'hotspot-dim-X-Z');
          drawLine(dimLines[4], 'hotspot-dot-X-Y-Z', 'hotspot-dot-X-Y+Z', 'hotspot-dim-X-Y');
        };

        // --- Posizionamento hotspot dimensioni in base al bounding box ---
        mv.addEventListener('load', ()=>{
          const c = mv.getBoundingBoxCenter();
          const s = mv.getDimensions(); // {x,y,z} (metri)
          const x2 = s.x/2, y2 = s.y/2, z2 = s.z/2;

          // Vertici
          mv.updateHotspot({ name:'hotspot-dot+X-Y+Z', position:`${c.x + x2} ${c.y - y2} ${c.z + z2}` });
          mv.updateHotspot({ name:'hotspot-dot+X-Y-Z', position:`${c.x + x2} ${c.y - y2} ${c.z - z2}` });
          mv.updateHotspot({ name:'hotspot-dot+X+Y-Z', position:`${c.x + x2} ${c.y + y2} ${c.z - z2}` });
          mv.updateHotspot({ name:'hotspot-dot-X+Y-Z', position:`${c.x - x2} ${c.y + y2} ${c.z - z2}` });
          mv.updateHotspot({ name:'hotspot-dot-X-Y-Z', position:`${c.x - x2} ${c.y - y2} ${c.z - z2}` });
          mv.updateHotspot({ name:'hotspot-dot-X-Y+Z', position:`${c.x - x2} ${c.y - y2} ${c.z + z2}` });

          // Etichette (testo come nella demo: cm, una per dimensione/faccia)
          mv.updateHotspot({ name:'hotspot-dim+X-Y', position:`${c.x + x2*1.2} ${c.y - y2*1.1} ${c.z}` });
          mv.querySelector('button[slot="hotspot-dim+X-Y"]').textContent = `${(s.z*100).toFixed(0)} cm`;

          mv.updateHotspot({ name:'hotspot-dim+X-Z', position:`${c.x + x2*1.2} ${c.y} ${c.z - z2*1.2}` });
          mv.querySelector('button[slot="hotspot-dim+X-Z"]').textContent = `${(s.y*100).toFixed(0)} cm`;

          mv.updateHotspot({ name:'hotspot-dim-X-Z', position:`${c.x - x2*1.2} ${c.y} ${c.z - z2*1.2}` });
          mv.querySelector('button[slot="hotspot-dim-X-Z"]').textContent = `${(s.y*100).toFixed(0)} cm`;

          mv.updateHotspot({ name:'hotspot-dim-Y-Z', position:`${c.x} ${c.y + y2*1.1} ${c.z - z2*1.1}` });
          mv.querySelector('button[slot="hotspot-dim-Y-Z"]').textContent = `${(s.x*100).toFixed(0)} cm`;

          mv.updateHotspot({ name:'hotspot-dim-X-Y', position:`${c.x - x2*1.2} ${c.y - y2*1.1} ${c.z}` });
          mv.querySelector('button[slot="hotspot-dim-X-Y"]').textContent = `${(s.z*100).toFixed(0)} cm`;

          renderSVG();
          setAnnoVisibility();
          setDimsVisibility(chkDims.checked);

          // Aggiorna le linee quando si muove la camera
          mv.addEventListener('camera-change', renderSVG);
        });
      })();
    </script>
  </body>
</html>
